---
title: CMAP Analysis
output:
  pdf_document: default
  html_notebook: default
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

# Introduction
This notebooks shows how to run a CMAP using the R scripts I've made on an example set of data. The code chunks should be able to run as-is. The first section includes all the required packages.   
 
# Loading packages and data
## CRAN packages
```{r}
require(devtools)
require(tidyverse)

```

## BioConductor packages
See this [link](https://bioconductor.org/install/) for details of how to install these packages.
```{r}
require(clusterProfiler)
require(limma)


```

## My packages and other github packages 
```{r}
devtools::install_github("https://github.com/lefeverde/basicOmics")
my_pkgs <- c("lefutils","lefplots", "basicOmics", "QSPpaper")

for(cur_pkg in my_pkgs){
  if(!cur_pkg %in% row.names(installed.packages())){
    devtools::install_github(paste0("lefeverde/", cur_pkg))
  }
  library(cur_pkg, character.only=TRUE)
}

devtools::install_github("cmap/cmapR")

```


# Performing CMAP analysis
## Analysis on example data
This shows how the code should work. The actual files are large and so require some heavy-duty hardware. So this chunk runs the CMAP functions on a smaller dataset, which is small enough to be included in this package. 

```{r}
test_gctx <-
  system.file('extdata',
              'test_sig_500x978.gctx_n500x978.gctx',
              package = 'QSPpaper',
              mustWork = TRUE)
test_data <-
  system.file('extdata',
              'test_gene_set.RData',
              package = 'QSPpaper',
              mustWork = TRUE)

load(test_data)
cids <- cmapR::read_gctx_ids(test_gctx, "col")
drug_vec_list <- gctx_to_sigList(test_gctx, cids)
cmap_res <- single_broad_wrapper(up_genes, down_genes, drug_vec_list, 2)

```
## Pre-processing the data the LINCS L1000 
The following chunks show I wrangled the LINCS data to get in a format that is a bit smaller, and works with my scripts. I use the [CMap Query Speedup Challenge](https://clue.io/data/CT#CT_QSPD) data, since it has already been processed so that each row is a unique gene mapped to the entrezgene ID. The metadata file can be obtained from [GEO](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE70138). To make things more convenient, I've combined the different metadata files into a single file.  
```{r}

library(cmapR)

sig_scores <- 
  fread('sig_score_n476251x10174.csv', stringsAsFactors = FALSE,verbose = TRUE, data.table = FALSE)

# Combined metadata file

trt_cps <- 
  inst_file %>% 
  filter(pert_type == 'trt_cp') %>% 
  filter(pert_time %in% c(6, 24))


cols_to_keep <- 
  which(colnames(sig_scores) %in% trt_cps$sig_id)
cols_to_keep <- c(1, cols_to_keep)

sig_scores_sub <- sig_scores[,cols_to_keep]

# write_gctx(sig_scores_sub, "sig_score_trt_cp_n204975x10174.gctx")

```

## Subsetting LINCS dataset
```{r}

trt_cp <- 
  read_rds('data/GSE92742_inst_metadata.rds') %>% 
  filter(pert_type == "trt_cp") %>% 
  distinct %>% 
  dplyr::select(one_of("pert_id", "sig_id"))
drgbnk_db <- 
  readRDS('data/pert_overlap_cmap_drugbank_stitch.rds')
drgbnk_db$stitch_name <- NULL
drgbnk_db$pubchem_cid <- NULL
drgbnk_db <- 
  na.omit(drgbnk_db) %>% 
  distinct
drug_meta <- inner_join(trt_cp, drgbnk_db)


gctx_file <- '/zfs1/dtaylor/cmap_data/clue_test_data/sig_score_trt_cp_n204975x10174.gctx'

cids <- read.gctx.meta(gctx_file, dimension = 'column')[[1]]
cids = cids[cids %in% drug_meta$sig_id]
cid_chunks <- chunker(cids, 10)

```
## Creating aggregate gene sets
```{r}

library(lefutils)

pth_info <- 
  read_delim("data/NAFLD_progression2path.txt", 
             "\t",
             col_names = FALSE) %>% 
  set_names(., c("nafld_category", "id"))

pths_to_keep <- 
  pth_info %>% filter(nafld_category %in% 1:4)

kegg_db <- 
  read_rds("data/c2_kegg_entrez_msigdb_v7.0_database.rds") %>% 
  right_join(., pth_info)

pths_to_use <- kegg_db %>% filter(nafld_category %in% 1:4)
gene_pth_list <- 
  split(pths_to_use, pths_to_use$nafld_category) %>% 
  map(function(x){
    x <- 
      str_split(x$entrezgene, "\\|") %>% 
      unlist %>% 
      unique
  }) 

gene_pth_list <- 
  seq_along(gene_pth_list) %>% map(function(i){
    nm <- names(gene_pth_list)[i]
    tibble(nafld_category=nm, entrezgene=gene_pth_list[[i]])
  }) %>% do.call(rbind, .)

adj_p_val_thresh <- .001

degs_out_pth <- 
  read_csv("data/degs_from_selected_pathways_20200122.csv") %>% 
  filter(gene_adj.P.Val < adj_p_val_thresh) %>% 
  mutate(gene_regulation=if_else(gene_logFC > 0, "up", "down"))
names(degs_out_pth)[1] <- "coefficient"
degs_out_pth$entrezgene <- as.character(degs_out_pth$entrezgene)
degs_out_pth <-  inner_join(degs_out_pth, gene_pth_list)
degs_out_pth$nafld_category <- paste0("nafld_category_", degs_out_pth$nafld_category)
degs_out_pth <- degs_out_pth %>% split(., .$coefficient)



deg_setlists <- 
  degs_out_pth %>% 
  map(function(x){
    degs_per_cat <- 
      split(x, x$nafld_category) %>% 
      map(function(y){
        up_genes <- y %>% 
          filter(gene_regulation == "up") %>% 
          pull(entrezgene) %>% 
          as.character %>% 
          unique %>% 
          paste(., collapse = ";")
        down_genes <- y %>% 
          filter(gene_regulation == "down") %>% 
          pull(entrezgene) %>% 
          as.character %>% 
          unique %>% 
          paste(., collapse = ";")
        return(tibble(up_genes, down_genes))
      }) %>% rbind_named_df_list(., "query_id")
  }) 



```

## Calculating CMap score
```{r}
cmap_res <- seq_along(deg_setlists) %>% 
  map(function(i){
    x <- names(deg_setlists)[i]
    gene_sets <- deg_setlists[[x]]
    map(cid_chunks, function(y){
      sig_list <- 
        gctx_to_sigList(gctx_file, y, decreasing_order = FALSE)
      out_res <- multi_broad_wrapper(gene_sets, sig_list, 4)
      out_res <- cbind(coefficient=x, out_res) %>% map_if(is.factor, as.character)
      out_res <- bind_cols(out_res)
    }) %>% 
      do.call(rbind, .) 
  }) 
names(cmap_res) <- names(deg_setlists)
# saveRDS(cmap_res, 'cmap_DEGs_from_pathway_clusters_res.rds')
```

# Creating Supplementary data file 2. all predicted drugs
## Adding drug metadata to results 

```{r}
drug_res <- 
  read_rds('cmap_DEGs_from_pathway_clusters_res.rds') %>% 
  bind_rows %>% 
  filter(abs(cmap_score) > 0)

names(drug_res)[2] <- "nafld_category"

meta_cols_to_keep <- 
  c("sig_id",
    "pert_id",
    "pert_iname")

trt_cp <-
  read_rds('../cmapAnalysis/GSE92742_inst_metadata.rds') %>% 
  filter(pert_type == "trt_cp") %>% 
  distinct

trt_cp <- trt_cp[,meta_cols_to_keep]

drgbnk_db <- 
  readRDS('data/pert_overlap_cmap_drugbank_stitch.rds')
ddb_full <- 
  read_rds("data/drugbank_db_metadata.rds") %>% 
  dplyr::select(-one_of("description","toxicity","mechanism_of_action", "classification"))
drgbnk_db$stitch_name <- NULL
drgbnk_db$pubchem_cid <- NULL
drgbnk_db <-  na.omit(drgbnk_db)

drgbnk_db <- drgbnk_db %>% 
  select(one_of("pert_id","drugbank_id" )) %>% 
  distinct


drgbnk_db <- drgbnk_db %>% 
  distinct %>% 
  left_join(., ddb_full)

trt_cp <- right_join(trt_cp, drgbnk_db)

drug_res <- inner_join(trt_cp, drug_res)




```

## Indicating which drugs are in clinical trials 
```{r}
gt_drugs <- 
  read_csv("clinical_trial_drugs_from_DrugBank.csv") %>% 
  filter(Fixed_Condition_Name %in% c("NASH","NAFLD")) %>% 
  separate_rows(.,Phase, sep = "\\|" ) %>% 
  group_by(DrugBank_ID) %>% 
  arrange(desc(Phase), .by_group=TRUE) %>%
  dplyr::slice(1) %>% 
  ungroup



nafld_drugs <- 
  gt_drugs %>% filter(Fixed_Condition_Name == "NAFLD") %>% 
  pull(DrugBank_ID) %>% 
  unique

nash_drugs <- 
  gt_drugs %>% filter(Fixed_Condition_Name == "NASH") %>% 
  pull(DrugBank_ID) %>% 
  unique
  


drug_res$clinical_trial_drug <- NA
drug_res$clinical_trial_drug[drug_res$drugbank_id %in% nafld_drugs] <- "NAFLD"
  
drug_res$clinical_trial_drug[drug_res$drugbank_id %in% nash_drugs] <- "NASH"  

```
## Cleaning up the results a little bit
```{r}
clst_map <- 
  c("PLI vs. N&S", "PF vs. N&S", "PF vs. PLI") %>% 
  setNames(., unique(drug_res$coefficient))
drug_res$coefficient <- unlist(clst_map[drug_res$coefficient])

pth_map <- 
  read_delim("data/NAFLD_categories_description.txt", ";", col_names = FALSE) %>% 
  setNames(., c("idx", "disease_category"))
pth_map$idx <- paste0("idx_", pth_map$idx)
pth_map <- pth_map$disease_category %>% 
  setNames(., pth_map$idx)

pth_nms <- names(pth_map)
pth_map <- str_to_title(pth_map) %>% gsub("And", "and", .)
names(pth_map) <- pth_nms

drug_res$nafld_category <- pth_map[drug_res$nafld_category]

drug_res <- drug_res[,c(9, 10, 1, 2, 3, 4, 5, 6, 7, 12, 8, 11)]
names(drug_res)[1] <- "comparison"
# write_csv(drug_res, "Data_file_S2_All_drugs.csv")

```

# Identifying top drugs 
## Data S2 CMAP drug predictions
```{r}
drug_res <- read.csv("data/Data_file_S2_All_drugs.csv.gz")

sub_res <- 
  drug_res %>% 
  group_by(comparison, nafld_category, pert_id) %>% 
  arrange(cmap_score, .by_group=TRUE) %>% 
  dplyr::slice(1) %>% 
  ungroup



# Pathway categories which match text
pth_cats <-  
  c("Insulin Resistance and Oxidative Stress",
    "Cell Stress, Apoptosis and Lipotoxicity",
    "Inflammation",
    "Fibrosis")

sub_res$nafld_category <- factor(sub_res$nafld_category, levels = pth_cats)
sub_res$nafld_category <- lvls_revalue(sub_res$nafld_category, paste0("C", seq(1,4)))


```

## Splitting results into drugs and chemicals
```{r}
drugs <- sub_res %>%
  filter(str_detect(groups, "approved")) %>% 
  group_by(comparison, nafld_category) %>% 
  arrange(cmap_score, .by_group=TRUE) %>% 
  mutate(drug_idx=row_number()) 



t10_drugs <- drugs %>% 
  dplyr::slice(1:10) %>% 
  ungroup %>% 
  group_by(drugbank_id) %>% 
  mutate(drug_freq=n(), ave_rank=mean(drug_idx)) %>% 
  ungroup()
dbid_order <- t10_drugs %>% 
  select(drugbank_id, drug_freq, ave_rank) %>% 
  distinct %>% 
  arrange(desc(drug_freq), ave_rank) %>% 
  pull(drugbank_id)
t10_drugs$drugbank_id <- factor(t10_drugs$drugbank_id, levels = dbid_order)



chemicals <- sub_res %>%
  filter(str_detect(groups, "approved", negate = TRUE)) %>% 
  group_by(comparison, nafld_category) %>% 
  arrange(cmap_score, .by_group=TRUE) %>% 
  mutate(drug_idx=row_number()) 

t10_chemicals <- chemicals %>% 
  dplyr::slice(1:10) %>% 
  group_by(drugbank_id) %>% 
  mutate(drug_freq=n(), ave_rank=mean(drug_idx)) %>% 
  ungroup()

dbid_order <- t10_chemicals %>% 
  select(drugbank_id, drug_freq, ave_rank) %>% 
  distinct %>% 
  arrange(desc(drug_freq), ave_rank) %>% 
  pull(drugbank_id)


t10_chemicals$drugbank_id <- factor(t10_chemicals$drugbank_id, levels = dbid_order)

```

## Making tables of top10 drugs and small molecules
```{r}
library(lefplots)
library(flextable)
library(officer)


cols_to_keep <- c("drugbank_id","name", "targets", "comparison", "nafld_category", "drug_idx")
drug_tbl <- t10_drugs[,cols_to_keep] %>% 
  arrange(drugbank_id) %>% 
  group_by(drugbank_id) %>% 
  arrange(drug_idx, nafld_category, comparison, .by_group=TRUE ) %>% 
  ungroup

fixed_nms <- c("DrugBank ID", "Drug Name", "Targets", "Comparison", "Category", "Rank")
names(drug_tbl) <- fixed_nms

std_border <-
    fp_border(color="black", width = 1) 

ft_tbl <- make_flextable(drug_tbl) %>% 
  border_inner(., std_border) %>% 
  merge_v(., j=c(1:3)) %>% 
  autofit

# save_as_docx(ft_tbl, path = "Table_S3_Drugs_predicted_by_CMAP.docx")

chem_tbl <- t10_chemicals[,cols_to_keep] %>% 
  arrange(drugbank_id) %>% 
  group_by(drugbank_id) %>% 
  arrange(drug_idx, nafld_category, comparison, .by_group=TRUE ) %>% 
  ungroup

fixed_nms <- c("DrugBank ID", "Drug Name", "Targets", "Comparison", "Category", "Rank")
names(chem_tbl) <- fixed_nms

ft_tbl <- make_flextable(chem_tbl) %>% 
  border_inner(., std_border) %>% 
  merge_v(., j=c(1:3)) %>% 
  autofit

# save_as_docx(ft_tbl, path = "Table_S4_Small_Molecules_predicted_by_CMAP.docx")

```





## Drug target and pathway data from Fen
```{r}
fen_data <- 
  read_delim("data-raw/data_from_fen/drug_target_family_pathway_links.txt", "\t") %>% 
  na.omit 
  
names(fen_data) <- names(fen_data) %>% 
  str_to_lower %>% 
  str_replace_all(., " ", "_")

fen_data <- fen_data %>% 
  filter(str_detect(source, "vs"))


tgts <- fen_data[,c(1,2,6)] %>% 
  distinct

pths <- fen_data[,c(1,2,7,8)] %>% 
  distinct

tmp_top10_res <- top10_res[,c(1:6, 12:13)]

```
## Highlighted drugs
```{r}

library('org.Hs.eg.db')

kegg_db <- read_rds("data-raw/kegg_pathway_hierarchy.rds")
kegg_map <- read_rds("data-raw/kegg_pathway_entrezgene.rds")
names(kegg_map) <- str_to_lower(names(kegg_map))
kegg_db <- left_join(kegg_db, kegg_map)
fens_pth <-  
  read_delim("NAFLD_progression2path.txt", "\t",col_names = FALSE) %>% 
  setNames(., c( "pathway_category", "id"))


paper_drugs <- 
  c("dorsomorphin", "amonafide", "yohimbine", "diethylcarbamazine", "guanfacine", "gliquidone")

tmp_trgts <- t10_long %>% 
  filter(pert_iname %in% paper_drugs) %>% 
  dplyr::select(pert_iname, targets) %>% 
  distinct %>% 
  setNames(., c("drug_name", "gene_name"))

gene_ids <- 
  mapIds(org.Hs.eg.db, unique(tmp_trgts$gene_name), 'ENTREZID', 'SYMBOL') %>% 
  enframe(., name = "gene_name", value = "entrezgene")

tmp_trgts <- 
  left_join( tmp_trgts, gene_ids) %>% 
  right_join(kegg_db, .) %>% 
  na.omit

pth_data <- left_join(tmp_trgts, fens_pth) %>% 
  na.omit 

```


