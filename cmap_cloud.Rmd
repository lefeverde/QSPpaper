---
title: "CMAP in the cloud"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

# Introduction 
This notebook is for the misc analysis that I'm using the HTC for. 

# Functions
```{r}

get_genes_by_thresh <- function(res_sub, n_genes){
  tmp_res <- res_sub %>% 
    arrange(desc(abs(t))) %>% 
    dplyr::slice(1:n_genes)
  
  up_genes <- tmp_res %>% 
    filter(t > 0) %>% 
    pull(entrezgene)
  up_genes <- as.character(up_genes)
  
  
  down_genes <- tmp_res %>% 
    filter(t < 0) %>% 
    pull(entrezgene)
  down_genes <- as.character(down_genes)
  return(list(up_genes, down_genes))
  
}


lamb_cmap_wrapper2 <- function(up_genes, down_genes, sig_list, n_cores=12){
  cres <- 
    mclapply(seq_along(sig_list), function(i){
      nm <- names(sig_list)[i]
      x <- sig_list[[i]]
      ks_up <- 
        get_ks_score(up_genes, x)
      ks_down <- 
        get_ks_score(down_genes, x)
      if(sum(sign(c(ks_up, ks_down))) == 0){
        cmap_score <- ks_up - ks_down
      } else {
        cmap_score <- 0
      }
      out_df <- tibble(sig_id=nm,ks_up,ks_down,cmap_score)
      
    },
    mc.cores = n_cores) %>% 
    do.call(rbind, .)
  return(as_tibble(cres))
}

lamb_cmap_wrapper <- function(up_genes, down_genes, sig_list ){
  cres <- 
    lapply(seq_along(sig_list), function(i){
     
      nm <- names(sig_list)[i]
      x <- sig_list[[i]]
      ks_up <- 
        get_ks_score(up_genes, x)
      ks_down <- 
        get_ks_score(down_genes, x)
      if(sum(sign(c(ks_up, ks_down))) == 0){
        cmap_score <- ks_up - ks_down
      } else {
        cmap_score <- 0
      }
      out_df <- tibble(sig_id=nm,ks_up,ks_down,cmap_score)
      
    }) %>% 
    do.call(rbind, .)
  return(as_tibble(cres))
}


get_ks_score <- function(gene_set, drug_signature){
  # Checks if drug_signature is in ascending order
  #TODO think about making this optional to speed things up
  if(all(drug_signature == cummin(drug_signature))){
    stop('Drug signature needs to be sorted in ascending order')
  }
  # Removing genes not in the drug signature
  gene_set <- gene_set[gene_set %in% names(drug_signature)]
  
  # V: Indexes of gene set witch match the drug signature
  # which is sorted in ascending order. 
  V <- sort(match(gene_set, names(drug_signature)))
  # t: number of genes in gene set
  t <- length(gene_set)
  
  j <- seq(1, t)
  n <- length(drug_signature)
  
  a <- max(j/t - V/n)
  b <- max(V/n - ((j - 1)/t))
  

  if(a > b) {
    ks <- a
    # Else feels kludgey, but I'm
    # but that is how Chen did it
    
  }
  if(b > a){
    ks <- -b
  }
  
  # Fixing edge case when a == b.
  # Just going to set KS to 0
  if(a ==  b){
    ks <- 0
  }
  return(ks)
}











res_to_cmap_scores <- function(res, cmap_data, abs_top_genes=150){
  stopifnot(class(cmap_data) == 'list')
  
  res_sub <- res %>% 
    filter(adj.P.Val < .05) %>% 
    arrange(desc(abs(logFC))) %>% 
    dplyr::slice(1:abs_top_genes)
  
  up_genes <- 
    filter(res_sub, logFC > 0) %>% 
    pull(entrezgene) %>% 
    unique(.)
  
  
  down_genes <- 
    filter(res_sub, logFC < 0) %>% 
    pull(entrezgene) %>% 
    unique(.)
  
  cmap_scores <- 
    mclapply(seq_along(cmap_data), function(i){
      drug_sig <- cmap_data[[i]]
      nm <- names(cmap_data)[i]
      cmap_score <-
        cmap_score_new(up_genes, down_genes, drug_sig)
      out_df <- 
        tibble(coefficient=nm, cmap_score)
      return(out_df)
    }, mc.cores = 15) %>% 
    do.call(rbind, .)
  
  
}



multi_sig_list_wrapper <- function(sig_lists, l1000_eset, nm_str='', n_perm=100, n_cores=15){
  if(is.null(names(sig_lists))){
    stop('sig_lists needs to be named')
  }
  sig_data <- pData(l1000_eset)
  e <- exprs(l1000_eset)
  
  for(i in seq_along(sig_lists)){
    nm <- names(sig_lists)[i]
    sig_list <- sig_lists[[i]]
    fn <- 
      paste0(nm_str,
             nm,
             '_nperm',
             n_perm, 
             '.rds')
    print(nm)
    
    l1000_out_res <- 
      lincs_parallel_wrapper(sig_list$upregulated, sig_list$downregulated, lincs_mat =e, n_cores = n_cores, n_perm = n_perm)
    
    l1000_out_res <- 
      cbind(sig_data[l1000_out_res$pert_desc_long,], l1000_out_res)
    l1000_out_res$pert_desc_long <- NULL
    
    saveRDS(l1000_out_res, file = fn)
      
  }
  
}



make_gene_sig_list <- function(res, n_genes=Inf){
  if(n_genes == Inf){
    n_genes <- nrow(res)
  }
  res <- 
    arrange(res, desc(abs(logFC))) %>% 
    dplyr::slice(1:n_genes)
  sig_list <- 
    split(res, res$logFC > 0) %>% 
    lapply(., function(x){
      unique(x$entrezgene) %>% 
        as.character
    }) %>% 
    setNames(., c('upregulated', 'downregulated'))
  return(sig_list)
  
}

uniquefy_base <- function(dat, group_col, val_col){
  ordered_dat <- dat[order(dat[group_col], -dat[val_col]), ]
  ordered_dat <- ordered_dat[!duplicated(ordered_dat[group_col]), ]
  logical_idxs <- row.names(dat) %in% row.names(ordered_dat)
  return(logical_idxs)
}

make_unique_cmap_list <- function(cmap_sub){
  e <- exprs(cmap_sub)
  f <- fData(cmap_sub)
  
  kegg_res_list <- 
    as_tibble(e) %>% 
    as.list(.) %>% 
    lapply(., function(x){
      data.frame(f['entrez_id'], val=x)
    })
  kegg_res_list <- 
    mclapply(kegg_res_list, function(x){
      
      genes_to_keep <-
        uniquefy_base(x, 'entrez_id', 'val')
      x[!genes_to_keep, 'val'] <- NA
      x <- 
        na.omit(x) %>% 
        setNames(., c('ids', 'rank')) # kludge to work with Chen's cmap function
      x <- x %>% 
        arrange(., ids)
      return(x)
    }, mc.cores = 11)
  
  return(kegg_res_list)
    
    
}

```
# Loading data & packages
```{r}
library(cmapR)
library(parallel)
library(basicOmics)
library(readr)
library(tidyverse) 
library(sendmailR)
library(ggplot2)
library(dplyr)
library(Biobase)
library(readr)
library(lefutils)

source('cmap.R')
source('lincs.R')

# cmap_data <- read_rds('chen_connectivity_map_02_eSet.rds')


```
# Uniquefying data 
```{r}
u_cmap_data <- make_unique_cmap_list(cmap_data)
# saveRDS(u_cmap_data, file='chen_connectivity_map_02_uniquefyied.rds')
```
# Getting results 
```{r}
u_cmap_data <- read_rds('chen_connectivity_map_02_uniquefyied.rds')
fib429 <- read_rds('fib3_v_lob1-2_429_gene_signature.rds')
n_perm <- 10000000

fn <- paste0('chen_connectivity_map_02_fib3vlob1-2_res_nperm', 
             n_perm, '.rds')

out_cmap_results <- 
  cmap_build02_parallel_wrapper(dz_genes_up = fib429$ENTREZID, 
                                dz_genes_down = NA, 
                                n_perm = n_perm,
                                n_cores =  11,
                                cmap_list = u_cmap_data)
saveRDS(out_cmap_results, file = fn)
```
# L1000 Landmark probes only
## Creating eSet 
```{r}
annotated_l1000_data <-
  cmapR::parse.gctx('annotated_GSE92742_Broad_LINCS_Level5_COMPZ_n473647x12328.gctx', rid = seq(1,978))
p <- annotated_l1000_data@cdesc
f <- annotated_l1000_data@rdesc
tmp_eset <- ExpressionSet(annotated_l1000_data@mat)
pData(tmp_eset) <- p
fData(tmp_eset) <- f
# saveRDS(tmp_eset, file = 'annotated_GSE92742_Broad_LINCS_Level5_COMPZ_n473647x978eSet.rds')

```
### Splitting eset into pieces 
```{r}
l1000_eset <- read_rds('annotated_GSE92742_Broad_LINCS_Level5_COMPZ_n473647x978eSet.rds')

p <- pData(l1000_eset)

cp_sigs <- 
  filter(p, pert_type == 'trt_cp') %>% 
  pull(sig_id)

lig_sigs <- 
  filter(p, pert_type == 'trt_lig') %>% 
  pull(sig_id)

l1000_cp <- l1000_eset[,cp_sigs]
# saveRDS(l1000_cp, file = 'GSE92742_lincs_lvl5_trt_cp_only_n205034x978eSet.rds')

l1000_lig <- l1000_eset[,lig_sigs]
# saveRDS(l1000_lig, file = 'GSE92742_lincs_lvl5_trt_lig_only_n205034x978eSet.rds')

```

## Approved drugs 
Actually, getting just the approved drugs is difficult. The annotations seems to be different from the repurposing than those in the annoted GCTX. 
```{r}
repurp <- 
  read_rds('l1000_repurposable_drugs_inst.rds')
l1000_eset <-
  read_rds('annotated_GSE92742_Broad_LINCS_Level5_COMPZ_n473647x978eSet.rds')
p <- pData(l1000_eset)
```
## Creating L1000 List
```{r}
n_cores <- 15 
e <- exprs(l1000_eset)
gene_ids <- row.names(e)
l1000_res <-  
  mclapply(seq(1, ncol(e)), function(i){
    data.frame(ids=gene_ids,rank=e[,i])
  }, mc.cores = n_cores)
# saveRDS(l1000_res, 'l1000_lvl5_n473647x978_list.rds')

```
## Checking againts Fib 3
```{r}
l1000_list <- 
  read_rds('l1000_lvl5_n473647x978_list.rds')

dis_sigs <- 
  read_rds('landmark_l1000_gene_signatures.rds')

fib3vlob2 <-
  dis_sigs$`Fibrosis_3-Lob_Inflam_2` %>% 
  filter(., adj.P.Val < .05) %>% 
  split(., .$logFC > 0) %>% 
  lapply(., function(x){
    x$entrezgene
  }) %>% 
  setNames(., c('upregulated','downregulated'))


out_l1000_res <-  
  cmap_build02_parallel_wrapper(fib3vlob2$upregulated, fib3vlob2$downregulated, l1000_list)

```

## Phase II data
The sig info but not others (e.g., sig_info_metric, _pert_, etc.,) seem to match with level 5 data. However, it's out of order for some reason.
```{r}
infile <- 'GSE70138_Broad_LINCS_Level5_COMPZ_n118050x12328_2017-03-06.gctx'
gene_data <- 
  read.delim('GSE70138_Broad_LINCS_gene_info_2017-03-06.txt', sep='\t')
l1000_pII <- cmapR::parse.gctx(infile, rid = which(gene_data$pr_is_lm == 1))
lndmrk_genes <- gene_data[which(gene_data$pr_is_lm == 1),]
row.names(lndmrk_genes) <- lndmrk_genes$pr_gene_id


sig_meta <- read.delim('GSE70138_Broad_LINCS_sig_info_2017-03-06.txt', sep = '\t')
row.names(sig_meta) <- sig_meta$sig_id
sig_meta <- sig_meta[l1000_pII@cid,]



l1000_eset <-
  ExpressionSet(l1000_pII@mat)
pData(l1000_eset) <- sig_meta
fData(l1000_eset) <- lndmrk_genes
# saveRDS(l1000_eset, file='l1000_lvl5_n118050x978_list.rds')


n_cores <- 15 
e <- exprs(l1000_eset)
gene_ids <- row.names(e)
l1000_list <-  
  mclapply(seq(1, ncol(e)), function(i){
    tibble(ids=gene_ids,rank=e[,i])
  }, mc.cores = n_cores)

names(l1000_list) <- colnames(l1000_eset)
n_perm <- 1000000


out_l1000_res <-  
  cmap_build02_parallel_wrapper(fib3vlob2$upregulated, fib3vlob2$downregulated, l1000_list, n_cores = n_cores, n_perm = n_perm)

p <- pData(l1000_eset) %>% 
  dplyr::select(-one_of("distil_id", 'sig_id'))


out_l1000_res <- 
  cbind(p[out_l1000_res$pert_desc_long,], out_l1000_res) %>% 
  dplyr::select(-one_of("pert_desc_long")) %>% 
  rownames_to_column('broad_id')

fn <- paste0('l1000_phaseII_lndmrk_fib3vlob2_res_nperm', 
             n_perm, '.rds')

saveRDS(out_l1000_res, fn)

```
## Fib3 v lob 
```{r}
dis_sigs <- 
  read_rds('landmark_l1000_gene_signatures.rds')
fib3vlob1_2 <- 
  dis_sigs[1:2] %>% 
  bind_rows %>% 
  filter(adj.P.Val < .05)
fib3vlob1_2 <- 
  split(fib3vlob1_2, fib3vlob1_2$logFC > 0) %>% 
  lapply(., function(x){
    unique(x$entrezgene) %>% 
      as.character
  }) %>% setNames(., c('upregulated', 'downregulated'))

n_cores <- 15 
n_perm <- 1000000

out_l1000_res <-  
  cmap_build02_parallel_wrapper(fib3vlob1_2$upregulated, fib3vlob1_2$downregulated, l1000_list, n_cores = n_cores, n_perm = n_perm)

p <- pData(l1000_eset) %>% 
  dplyr::select(-one_of("distil_id", 'sig_id'))


out_l1000_res <- 
  cbind(p[out_l1000_res$pert_desc_long,], out_l1000_res) %>% 
  dplyr::select(-one_of("pert_desc_long")) %>% 
  rownames_to_column('broad_id')

fn <- paste0('l1000_phaseII_lndmrk_fib3vlob1-2_res_nperm', 
             n_perm, '.rds')

saveRDS(out_l1000_res, fn)
```
## Comparing different number of landmark genes
I'm starting to wonder about this approach where I combine lob 1 & 2 and then uniquefying them. It might be best to redo the analysis combining lob 1-2 vs fib 3 or do them seperately. 
```{r}

l1000_eset <-
  read_rds('annotated_GSE92742_Broad_LINCS_Level5_COMPZ_n473647x978eSet.rds')
dis_sigs <- 
  read_rds('landmark_l1000_gene_signatures.rds')
res_sub <- 
  dis_sigs[1:2] %>% 
  bind_rows %>% 
  uniquefy_by_abs_max(., 'entrezgene', 't')


e <-  exprs(l1000_eset)
sig_data <- pData(l1000_eset)

n_genes <- c(10, 20, 50, 100, 200, 400, 600, 971)
sig_lists <- lapply(n_genes, function(x){
  make_gene_sig_list(res_sub, x)
}) %>% setNames(., c(paste0('LMRK',n_genes)))

n_perm <- 10000
n_cores <- 15

for(i in seq_along(sig_lists)){
  nm <- names(sig_lists)[i]
  sig_list <- sig_lists[[i]]
  fn <- 
    paste0('l1000_GSE92742_n473647x978_fib3vlob2_res_',
           nm,
           '_nperm',
           n_perm, 
           '.rds')
  print(nm)
  l1000_out_res <- 
    lincs_parallel_wrapper(sig_list$upregulated, sig_list$downregulated, lincs_mat =e, n_cores = n_cores, n_perm = n_perm)
  
  l1000_out_res <- 
    cbind(sig_data[l1000_out_res$pert_desc_long,], l1000_out_res)
  l1000_out_res$pert_desc_long <- NULL
  saveRDS(l1000_out_res, file = fn)
}

```




## Landmark Fib 3 v Lob 1 
```{r}

dis_sigs <- 
  read_rds('landmark_l1000_gene_signatures.rds')

sig_list <-
  dis_sigs$`Fibrosis_3-Lob_Inflam_1` %>% 
  filter(., adj.P.Val < .05) %>% 
  make_gene_sig_list


l1000_eset <-
  read_rds('GSE92742_lincs_lvl5_trt_cp_only_n205034x978eSet.rds')

e <- exprs(l1000_eset)
# e <- e[,1:1000]
sig_data <- pData(l1000_eset)
n_perm <- 1000000
n_cores <- 15

l1000_out_res <- 
  lincs_parallel_wrapper(sig_list$upregulated, sig_list$downregulated, lincs_mat =e, n_cores = n_cores, n_perm = n_perm)

l1000_out_res <- 
  cbind(sig_data[l1000_out_res$pert_desc_long,], l1000_out_res)
l1000_out_res$pert_desc_long <- NULL

fn <- 
  paste0('rges_fib3vlob1_l1000_res_GSE92742_n205034x978_trt_cp_nperm', format(n_perm, scientific = FALSE), '.rds')
  
  
saveRDS(l1000_out_res, fn)
```
### Old CMAP Score
```{r}

e <- exprs(l1000_eset)
sig_data <- pData(l1000_eset)
n_perm <- 1000
n_cores <- 15

l1000_out_res <- 
  lincs_parallel_wrapper(sig_list$upregulated, sig_list$downregulated, lincs_mat =e, n_cores = n_cores, n_perm = n_perm, cmap_function = cmap_score_old)

l1000_out_res <- 
  cbind(sig_data[l1000_out_res$pert_desc_long,], l1000_out_res)
l1000_out_res$pert_desc_long <- NULL

fn <- 
  paste0('cmap_score_fib3vlob1_l1000_res_GSE92742_n205034x978_trt_cp_nperm', format(n_perm, scientific = FALSE), '.rds')

saveRDS(l1000_out_res, file = fn)
```

## Landmark Fib 3 v Lob 2 
```{r}

dis_sigs <- 
  read_rds('landmark_l1000_gene_signatures.rds')

sig_list <-
  dis_sigs$`Fibrosis_3-Lob_Inflam_2` %>% 
  filter(., adj.P.Val < .05) %>% 
  make_gene_sig_list


l1000_eset <-
  read_rds('GSE92742_lincs_lvl5_trt_cp_only_n205034x978eSet.rds')

e <- exprs(l1000_eset)
sig_data <- pData(l1000_eset)
n_perm <- 1000000
n_cores <- 15

l1000_out_res <- 
  lincs_parallel_wrapper(sig_list$upregulated, sig_list$downregulated, lincs_mat =e, n_cores = n_cores, n_perm = n_perm)

l1000_out_res <- 
  cbind(sig_data[l1000_out_res$pert_desc_long,], l1000_out_res)
l1000_out_res$pert_desc_long <- NULL

fn <- 
  paste0('rges_fib3vlob2_l1000_res_GSE92742_n205034x978_trt_cp_nperm', format(n_perm, scientific = FALSE), '.rds')
  
  
saveRDS(l1000_out_res, fn)
```
### Old CMAP Score
```{r}

e <- exprs(l1000_eset)
sig_data <- pData(l1000_eset)
n_perm <- 1000
n_cores <- 15

l1000_out_res <- 
  lincs_parallel_wrapper(sig_list$upregulated, sig_list$downregulated, lincs_mat =e, n_cores = n_cores, n_perm = n_perm, cmap_function = cmap_score_old)

l1000_out_res <- 
  cbind(sig_data[l1000_out_res$pert_desc_long,], l1000_out_res)
l1000_out_res$pert_desc_long <- NULL

fn <- 
  paste0('cmap_score_fib3vlob2_l1000_res_GSE92742_n205034x978_trt_cp_nperm', format(n_perm, scientific = FALSE), '.rds')

saveRDS(l1000_out_res, file = fn)
```
# Creating test L1000 landmark eSet
```{r}
l1000_eset <- 
  readRDS('GSE92742_lincs_lvl5_trt_cp_only_n205034x978eSet.rds')

p_sub <- 
  filter(p, grepl('^[a-z]', p$pert_iname)) %>% 
  filter(is_touchstone==1) %>% 
  filter(is_exemplar == 1)

high_tas_sigs <- 
  arrange(p_sub, desc(tas)) %>% 
  dplyr::slice(1:1000) %>% 
  pull(sig_id)

low_tas_sigs <- 
  arrange(p_sub, tas) %>% 
  dplyr::slice(1:1000)  %>% 
  pull(sig_id)

sigs_to_keep <- c(high_tas_sigs, low_tas_sigs)
l1000_sub <- l1000_eset[,sigs_to_keep]
# saveRDS(l1000_sub, file='test_l1000_n2000x978.rds')

```


# L1000 all probes 
## Creating eSet
```{r}
gctx_file <- 'GSE92742_Broad_LINCS_Level5_COMPZ.MODZ_n473647x12328.gctx'
p <- 
  read_rds('l1000_inst_metadata.rds') %>% 
  filter(pert_type == 'trt_cp')

cp_sigs <- p %>% pull(sig_id)

gctx_ids <- cmapR::read.gctx.meta(gctx_file, 'col')

cols_to_keep <- match(cp_sigs, gctx_ids$id)

e <- cmapR::parse.gctx('GSE92742_Broad_LINCS_Level5_COMPZ.MODZ_n473647x12328.gctx', 
                       cid = cols_to_keep, 
                       matrix_only = TRUE)

f <- e@rdesc
row.names(f) <- f$id
annots <- select(org.Hs.eg.db, keys=f$id,columns=c("SYMBOL","GENENAME"), keytype="ENTREZID")
names(annots) <-  names(annots) %>% str_to_lower
names(annots)[1] <- 'entrezgene'
row.names(annots) <- annots$entrezgene

l1000_eset <- ExpressionSet(e@mat)
pData(l1000_eset) <- p
fData(l1000_eset) <- annots
rm(e)
gc()

saveRDS(l1000_eset, file = 'GSE92742_lincs_lvl5_trt_cp_only_n205034x12328eSet.rds')
```
### Splitting eset into pieces 


## Fib 3 vs lob 1 signature 
```{r}

l1000_eset <- read_rds('GSE92742_lincs_lvl5_trt_cp_only_n205034x12328eSet.rds')
p <- pData(l1000_eset)
row.names(p) <- p$sig_id
pData(l1000_eset) <- p
all_res <- read_rds('all_coef_res_df.rds')
coefs_to_keep <-  "Fibrosis_3-Lob_Inflam_1"
# coefs_to_keep <-  "Fibrosis_3-Lob_Inflam_2"
res_sub <- all_res %>% 
  filter(coefficient %in% coefs_to_keep) %>% 
  filter(adj.P.Val < .05) %>% 
  uniquefy_by_abs_max(., 'entrezgene', 't')


n_genes <- c(50, 100, 200, 300, 500, 1000)
sig_lists <- lapply(n_genes, function(x){
  make_gene_sig_list(res_sub, x)
}) %>% setNames(., c(paste0('nDEGs',n_genes)))

multi_sig_list_wrapper(sig_lists, l1000_eset, nm_str ='fib3vlob1_GSE92742_n205034x978_trt_cp' )

```
## Fib 3 vs lob 2 signature 
```{r}

l1000_eset <- read_rds('GSE92742_lincs_lvl5_trt_cp_only_n205034x12328eSet.rds')
p <- pData(l1000_eset)
row.names(p) <- p$sig_id
pData(l1000_eset) <- p

res <- read_rds('DiStefano_all_coefs_qn_sva_res.rds')
coefs_to_keep <- c("Fibrosis_3-Lob_Inflam_2")
res_sub <- res %>% 
  filter(coefficient %in% coefs_to_keep)

res_sub <- all_res %>% 
  filter(coefficient %in% coefs_to_keep) %>% 
  filter(adj.P.Val < .05) 

gene_thresh <- c(50, 100, 200, 400, 600, 800, 1000)
thresh_names <- paste0('ngenes_', gene_thresh)
sig_lists <- lapply(gene_thresh, function(x){
  make_gene_sig_list(res_sub, x)
}) %>% setNames(., thresh_names)

multi_sig_list_wrapper(sig_lists, l1000_eset, nm_str ='fib3vlob2_GSE92742_n205034x12328_trt_cp', n_perm = 1, n_cores = 8 )

```
## Fib 429 Sig 
```{r}
fib429 <-  read_rds('fib3_v_lob1-2_429_gene_signature.rds')
l1000_eset <- read_rds('GSE92742_lincs_lvl5_trt_cp_only_n205034x12328eSet.rds')
p <- pData(l1000_eset)
row.names(p) <- p$sig_id
pData(l1000_eset) <- p

e <- exprs(l1000_eset)
# e <- e[,1:1000]
sig_data <- pData(l1000_eset)
n_perm <- 1000
n_cores <- 15

l1000_out_res <- 
  lincs_parallel_wrapper(fib429$ENTREZID, NA, lincs_mat =e, n_cores = n_cores, n_perm = n_perm)

l1000_out_res <- 
  cbind(sig_data[l1000_out_res$pert_desc_long,], l1000_out_res)
l1000_out_res$pert_desc_long <- NULL

fn <- 
  paste0('fib429_l1000_res_GSE92742_n205034x12328_trt_cp_nperm', format(n_perm, scientific = FALSE), '.rds')
  
  
saveRDS(l1000_out_res, fn)

```


# Comparing CMAP02 to L1000
```{r}
l1000_eset <- 
  read_rds('GSE92742_lincs_lvl5_trt_cp_only_n205034x12328eSet.rds')
l1000_p <- pData(l1000_eset)
row.names(l1000_p) <- l1000_p$sig_id
pData(l1000_eset) <- l1000_p


l1000_p <- 
  pData(l1000_eset) %>% 
  select(c("sig_id","pert_iname", "cell_id", "pert_time","pert_dose" )) %>% 
  setNames(., c('l1000_id', 'drug', 'cell', 'time', 'concentration'))


cmap02 <- 
  read_rds('chen_connectivity_map_02_uniquefyied.rds')
cmap02_p <- 
  read_rds('chen_cmap_pdata.rds') %>% 
  select(c("id", "name","cell_line", "duration", "concentration")) %>% 
  setNames(., c('cmap02_id', 'drug', 'cell', 'time', 'concentration'))

# p1 <- l1000_p %>% 
#   select(-one_of("concentration")) %>% 
#   distinct
# p2 <- cmap02_p %>% 
#   select(-one_of("concentration")) %>% 
#   distinct
p1 <- l1000_p
p2 <- cmap02_p
p2$concentration <- p2$concentration*10^6

met_overlap <-  dplyr::intersect(p1[,2:(ncol(p1) -1 )], p2[,2:(ncol(p2) -1 )])
p1 <- inner_join(p1, met_overlap)
p2 <- inner_join(p2, met_overlap)

d1 <- group_by(p1, drug, cell) %>% 
  summarise(l1000_drug_cnt=n())
d2 <- group_by(p2, drug, cell) %>% 
  summarise(cmap02_drug_cnt=n())
drg_cnts <- cbind(d1, cmap02_drug_cnt=d2$cmap02_drug_cnt)
drg_cnts$drug_difs <- drg_cnts$l1000_drug_cnt - drg_cnts$cmap02_drug_cnt

tmp_row <- tf3[1592,1:2]

tmp_drug <- 'fulvestrant'
tmp_cell <- 'MCF7'

l1000_rows <- 
  filter(p1, drug == tmp_drug & cell == tmp_cell)
cmap02_rows <- 
  filter(p2, drug == tmp_drug & cell == tmp_cell)
if(dim(l1000_rows)[1] == dim(cmap02_rows)[1]){
  l1000_rows <- 
    l1000_rows %>% 
    arrange(concentration) %>% 
    mutate(conc_rank=seq(1, dim(.)[1]))
  cmap02_rows <- 
    cmap02_rows %>% 
    arrange(concentration) %>% 
    mutate(conc_rank=seq(1, dim(.)[1]))
}

conc1 <- l1000_rows$concentration
conc2 <- cmap02_rows$concentration
conc_diffs <-  outer(conc1, conc2, `-`) %>% 
  abs



```

# Kludge-y comparison of HemoShear to Patient data
```{r}

load('tmp_hemo_patient_res_data.RData')

get_thresh_cors2 <- function(single_res, multi_res, nintervals=1000){
  
  
  min_fdr_p_val <- 
    c(single_res$adj.P.Val, multi_res$adj.P.Val) %>% 
    min
  # 
  # thresh_list <- 
  #   -log10(seq(min_fdr_p_val, 1, length.out = nintervals))
  thresh_list <- 
    c(seq(0, .25, length.out = nintervals),
      seq(.25, 1, length.out = nintervals))
  
  ol <- mclapply(thresh_list, function(x){
   
    tmp_res1 <- 
      filter(single_res, adj.P.Val < x)
      # filter(single_res, -log10(adj.P.Val) > x)
    filt_multi_res <-
      filter(multi_res, adj.P.Val < x) %>%
      # filter(multi_res, -log10(adj.P.Val) > x) %>%
      split(., .$coefficient)
    cor_res <- 
      lapply(seq_along(filt_multi_res), function(i){
        tmp_res2 <- filt_multi_res[[i]]
        coef_name <- names(filt_multi_res)[[i]]
        
        genes_to_keep <- intersect(tmp_res1$gene_id, tmp_res2$gene_id)
        if(length(genes_to_keep) < 1){
          out_df <- 
            data.frame(coefficient=coef_name,
                       spearman_rho=0,
                       fdr_p_val_threshold=x, 
                       n_genes=0)
          return(out_df)
        }
        
        tmp_res1 <- 
          filter(tmp_res1, gene_id %in% genes_to_keep) %>% 
          arrange(gene_id)
        
        tmp_res2 <- 
          filter(tmp_res2, gene_id %in% genes_to_keep) %>% 
          arrange(gene_id)
        
        stopifnot(tmp_res1$gene_id == tmp_res2$gene_id)
        cor_res <-  
          cor(tmp_res1$t, tmp_res2$t, method = 'spearman')
        out_df <- 
          tibble(coefficient=coef_name,
                     spearman_rho=cor_res,
                     fdr_p_val_threshold=x, 
                     n_genes=length(genes_to_keep))
      }) %>% do.call(rbind, .)
    
  }, mc.cores=15) %>% do.call(rbind, .)
  return(ol)
}
cor_res <- get_thresh_cors2(hemo_res, patient_data_sub, 1000)

min_fdr_p_val <- 
  c(hemo_res$adj.P.Val, patient_data_sub$adj.P.Val) %>% 
  min


```

# Quick comparison to Chen v Lamb
```{r}

res <- readRDS('all_coef_res_df.rds')

res_sub <- 
  filter(res, coefficient %in% "Fibrosis-Lob") %>%
  filter(adj.P.Val < .05) %>% 
  arrange(desc(abs(logFC))) %>% 
  dplyr::slice(1:150)

up_genes <- 
  filter(res_sub, logFC > 0) %>% 
  pull(entrezgene) %>% 
  unique(.)


down_genes <- 
  filter(res_sub, logFC < 0) %>% 
  pull(entrezgene) %>% 
  unique(.)

cmap_old_scores <- 
  mclapply(seq_along(cmap_data), function(i){
    drug_sig <- cmap_data[[i]]
    nm <- names(cmap_data)[i]
    cmap_score <- cmap_score_old(up_genes, down_genes, drug_sig)
    out_df <- tibble(coefficient=nm,
                     cmap_score)
    return(out_df)
  }, mc.cores = 15) %>% do.call(rbind, .)

cmap_new_scores <- 
  mclapply(seq_along(cmap_data), function(i){
    drug_sig <- cmap_data[[i]]
    nm <- names(cmap_data)[i]
    cmap_score <- cmap_score_new(up_genes, down_genes, drug_sig)
    out_df <- tibble(coefficient=nm,
               cmap_score)
    return(out_df)
  }, mc.cores = 15) %>% do.call(rbind, .)



```


# Getting Lincs for NAFLD up to and including normal res
```{r}
res <- 
  readRDS('all_coef_res_df.rds') %>% 
  filter(., coefficient %in% "NAFLD-Normal") 

drug_sigs <-
  read_rds('GSE92742_lincs_lvl5_trt_cp_only_n205034x12328eSet.rds')

test_idxs <- sample(1:ncol(drug_sigs), size = 100)
# nms <- colnames(drug_sigs)[test_idxs]
nms <- colnames(drug_sigs)

# e <- exprs(drug_sigs)[,test_idxs]
e <- exprs(drug_sigs)

drug_sigs <- lapply(1:ncol(e), function(i){
  tibble(ids=row.names(e), rank=e[,i])
}) %>% setNames(., nms)

out_res <- res_to_cmap_scores(res, drug_sigs)

ngene_thresh <- c(50, 150, 250, 350, 500)
ol <- lapply(ngene_thresh, function(x){
  res_to_cmap_scores(res, drug_sigs, abs_top_genes = x)
}) %>% setNames(., paste0('ngenes_', ngene_thresh))

saveRDS(ol, 'nafld_v_normal_ngene_thresh_l1000_GSE92742_res.rds')
```

# Creating test data from contest res
```{r}

library(data.table)
sig_scores <- 
  fread('/zfs1/dtaylor/cmap_data/clue_test_data/sig_score_n476251x10174.csv', stringsAsFactors = FALSE,verbose = TRUE, data.table = FALSE)
gt_sub <- read_rds('ground_truth_250_subset_top100_sigs.rds')


gene_ids <- sig_scores$V1
sig_subset <- cbind(gene_id=gene_ids,sig_scores[,gt_sub$sig_id])
# saveRDS(sig_subset, 'sig_score_subset_n4917x10174.rds')

```
## Creating approved drug subset
```{r}

library(data.table)
sig_scores <- 
  fread('/zfs1/dtaylor/cmap_data/clue_test_data/sig_score_n476251x10174.csv', stringsAsFactors = FALSE,verbose = TRUE, data.table = FALSE)

inst_data <- 
  read_rds('GSE92742_inst_metadata.rds')

approved_drugs <- 
  inst_data %>% 
  filter(pert_type == 'trt_cp') %>% 
  filter(., str_detect(pert_iname, 'BRD', negate = TRUE)) %>% 
  # filter(is_touchstone == 1) %>% 
  # filter(is_exemplar == 1) %>% 
  filter(pert_time %in% c(6, 24))

approved_drugs <- 
    approved_drugs[grepl('^[[:lower:]]+', approved_drugs$pert_iname),]  



cols_to_keep <- 
  which(colnames(sig_scores) %in% approved_drugs$sig_id)
cols_to_keep <- c(1, cols_to_keep)

sig_scores_sub <- sig_scores[,cols_to_keep]
# saveRDS(sig_scores_sub, file = '/zfs1/dtaylor/cmap_data/clue_test_data/sig_score_approved_drug_n67019x10174.rds')


trt_cps <- 
  inst_data %>% 
  filter(pert_type == 'trt_cp') %>% 
  filter(pert_time %in% c(6, 24))


cols_to_keep <- 
  which(colnames(sig_scores) %in% trt_cps$sig_id)
cols_to_keep <- c(1, cols_to_keep)

sig_scores_sub <- sig_scores[,cols_to_keep]
# saveRDS(sig_scores_sub, file = '/zfs1/dtaylor/cmap_data/clue_test_data/sig_score_trt_cp_n204976x10174.rds')

```

# CMAP using GSEA on selected number of DEGs
## Loading the data 
```{r}
# sig_scores <- 
#   read_rds('/zfs1/dtaylor/cmap_data/clue_test_data/sig_score_trt_cp_n204976x10174.rds')

# sig_list <- 
#   as.list(sig_scores[,2:ncol(sig_scores)]) %>% 
#   mclapply(., function(x){
#     x <- x %>% 
#       setNames(., sig_scores$V1)
#     x <- sort(x, decreasing = TRUE)
#   }, mc.cores = 4) %>% 
#   setNames(., colnames(sig_scores)[2:ncol(sig_scores)])

gctx_file <- '/zfs1/dtaylor/cmap_data/clue_test_data/sig_score_trt_cp_n204975x10174.gctx'
cids <- read.gctx.meta(gctx_file, dimension = 'column')[[1]]
# cids <- cids[1:50]
cid_chunks <- chunker(cids, 10)
# cid_chunks <- chunker(cids, 2)

# saveRDS(sig_list, '/zfs1/dtaylor/cmap_data/clue_test_data/sig_score_as_vec_list_approved_drug_n67019x10174.rds')
print('loaded siglist ')
```


## Normal results 
```{r}
print("running normal res cmap")
res <- read_rds('DiStefano_all_coefs_qn_sva_res.rds')
# coefs_to_keep <- c("Fibrosis_3-Lob_Inflam_2")
coefs_to_keep <- "Fibrosis_3-(Lob_Inflam_1+Lob_Inflam_2)/2"  
# coefs_to_keep <- unique(res$coefficient)

res_sub <- res %>% 
  filter(coefficient %in% coefs_to_keep)

gene_thresh <- c(50, 100, 200, 400, 600, 800, 1000)
thresh_names <- paste0('ngenes_', gene_thresh)
coefs <- unique(res_sub$coefficient)
res_list <- 
  lapply(cid_chunks, function(cur_chunk){
    sig_list <- gctx_to_sigList(gctx_file, cur_chunk)
    lapply(coefs, function(x){
      res_sub <- 
        res %>% 
        filter(coefficient == x)
      
      gene_sets <- 
        lapply(seq_along(gene_thresh), function(i){
          query_id <- thresh_names[i]
          n_genes <- gene_thresh[i]
          tmp_res <- res_sub %>% 
            arrange(desc(abs(t))) %>% 
            dplyr::slice(1:n_genes)
          up_genes <- tmp_res %>% 
            filter(t > 0) %>% 
            pull(entrezgene)
          up_genes <- as.character(up_genes)
          up_genes <- paste0(up_genes, collapse = ';')
          
          down_genes <- tmp_res %>% 
            filter(t < 0) %>% 
            pull(entrezgene)
          down_genes <- as.character(down_genes)
          down_genes <- paste0(down_genes, collapse = ';')
          return(tibble(query_id, up_genes, down_genes))
          
        }) %>% do.call(rbind, .)
      
      out_res <- cmap_fgsea_wrapper(gene_sets, sig_list, 8)
      out_res <- cbind(coefficient=x, out_res)
      
      return(out_res)
    }) %>% do.call(rbind, .)  
  }) %>% do.call(rbind, .)



# fn <-
#   'Distefano_all_coefs_cmap_gsea_cp_l1000_res.rds'
fn <-  'Fibrosis_3-(Lob_Inflam_1+Lob_Inflam_2)_cmap_gsea_cp_l1000_res.rds'

saveRDS(res_list, file = fn)

print("finished normal res cmap")

```

## Treat log2(1.2)
```{r}
print("start treat log2(1.2) res ")

res <- 
  read_rds('DiStefano_all_coefs_qn_sva_treat_lfc_log2_1.2_res.rds')
# coefs_to_keep <- c("Fibrosis_3-Lob_Inflam_2")
coefs_to_keep <- "Fibrosis_3-(Lob_Inflam_1+Lob_Inflam_2)/2"  
# coefs_to_keep <- unique(res$coefficient)

res_sub <- res %>% 
  filter(coefficient %in% coefs_to_keep)

gene_thresh <- c(50, 100, 200, 400, 600, 800, 1000)
thresh_names <- paste0('ngenes_', gene_thresh)
coefs <- unique(res_sub$coefficient)
res_list <- 
  lapply(cid_chunks, function(cur_chunk){
    sig_list <- gctx_to_sigList(gctx_file, cur_chunk)
    lapply(coefs, function(x){
      res_sub <- 
        res %>% 
        filter(coefficient == x)
      
      gene_sets <- 
        lapply(seq_along(gene_thresh), function(i){
          query_id <- thresh_names[i]
          n_genes <- gene_thresh[i]
          tmp_res <- res_sub %>% 
            arrange(desc(abs(t))) %>% 
            dplyr::slice(1:n_genes)
          up_genes <- tmp_res %>% 
            filter(t > 0) %>% 
            pull(entrezgene)
          up_genes <- as.character(up_genes)
          up_genes <- paste0(up_genes, collapse = ';')
          
          down_genes <- tmp_res %>% 
            filter(t < 0) %>% 
            pull(entrezgene)
          down_genes <- as.character(down_genes)
          down_genes <- paste0(down_genes, collapse = ';')
          return(tibble(query_id, up_genes, down_genes))
          
        }) %>% do.call(rbind, .)
      
      out_res <- cmap_fgsea_wrapper(gene_sets, sig_list, 9)
      out_res <- cbind(coefficient=x, out_res)
      
      return(out_res)
    }) %>% do.call(rbind, .)  
  }) %>% do.call(rbind, .)


# fn <-
#   'Distefano_all_coefs_treat_lfc_cmap_gsea_cp_l1000_res.rds'
fn <- "Fibrosis_3-(Lob_Inflam_1+Lob_Inflam_2)_treat_lfc_cmap_gsea_cp_l1000_res.rds"  


saveRDS(res_list, file = fn)
print("finished treat log2(1.2) res ")


```



# CMAP Using Lamb original method
## Fib3 v lob 2
```{r}
gctx_file <- 
  '/zfs1/dtaylor/cmap_data/clue_test_data/sig_score_trt_cp_n204975x10174.gctx'

res_sub <- 
  read_rds('DiStefano_all_coefs_qn_sva_treat_lfc_log2_1.2_res.rds') %>% 
  filter(coefficient == "Fibrosis_3-Lob_Inflam_2")
coefs_to_keep <- "Fibrosis_3-(Lob_Inflam_1+Lob_Inflam_2)/2"  

inst_data <- 
  read_rds('GSE92742_inst_metadata.rds')

trt_cps <- 
  inst_data %>% 
  filter(pert_type == 'trt_cp') %>% 
  filter(pert_time %in% c(6, 24)) %>% 
  filter(is_touchstone == 1)
cids <- trt_cps$sig_id



gene_thresh <- c(200)
query_id <- paste0('ngenes_', gene_thresh)

sig_list <- gctx_to_sigList(gctx_file, cids, decreasing_order = FALSE)
gene_set <- get_genes_by_thresh(res_sub, gene_thresh)

out_res <- lamb_cmap_wrapper(gene_set[[1]], gene_set[[2]], sig_list)
out_res <- 
  cbind.data.frame(coefficient='Fibrosis_3-Lob_Inflam_2', query_id, out_res, stringsAsFactors=FALSE)
saveRDS(out_res,'Fibrosis_3-Lob_Inflam_2_lamb_trt_cp_l1000_res.rds')

```


## Normal results 
```{r}

print("running normal res cmap")
res <- read_rds('DiStefano_all_coefs_qn_sva_res.rds')

# coefs_to_keep <- unique(res$coefficient)
coefs_to_keep <- "Fibrosis_3-(Lob_Inflam_1+Lob_Inflam_2)/2"  
res_sub <- res %>% 
  filter(coefficient %in% coefs_to_keep)

gene_thresh <- c(50, 100, 200, 400, 600, 800, 1000)
# gene_thresh <- c(50, 100, 200)
thresh_names <- paste0('ngenes_', gene_thresh)
coefs <- unique(res_sub$coefficient)
# coefs <- unique(res_sub$coefficient)[1:3]
res_list <- 
  # Loops over the gctx file
  lapply(cid_chunks, function(cur_chunk){
    sig_list <- gctx_to_sigList(gctx_file, cur_chunk, decreasing_order = FALSE)
    # Loops over coefficients
    lapply(coefs, function(x){
      res_sub <- 
        res %>% 
        filter(coefficient == x)
      # Loops over gene thresh
      cmap_res <- 
        lapply(seq_along(gene_thresh), function(i){
          query_id <- thresh_names[i]
          n_genes <- gene_thresh[i]
          tmp_res <- res_sub %>% 
            arrange(desc(abs(t))) %>% 
            dplyr::slice(1:n_genes)
          
          up_genes <- tmp_res %>% 
            filter(t > 0) %>% 
            pull(entrezgene)
          up_genes <- as.character(up_genes)
          
          
          down_genes <- tmp_res %>% 
            filter(t < 0) %>% 
            pull(entrezgene)
          down_genes <- as.character(down_genes)
          
          out_res <- lamb_cmap_wrapper2(up_genes, down_genes, sig_list, n_cores = 12)
          out_res <- 
            cbind.data.frame(query_id, out_res, stringsAsFactors=FALSE)
          
        }) %>% 
        do.call(rbind, .)
        #setNames(., thresh_names) %>% 
        #rbind_named_df_list(., 'query_id')
      
      return(cmap_res)
    }) %>% 
      setNames(., coefs) %>% 
      rbind_named_df_list(., 'coefficient')
  })  %>% 
  do.call(rbind, .)
# saveRDS(res_list, file = 'Fibrosis_3-Lob_Inflam_2_lamb_trt_cp_l1000_res.rds')


# fn <-
#   'Distefano_all_coefs_lamb_trt_cp_l1000_res.rds'
fn <- "Fibrosis_3-(Lob_Inflam_1+Lob_Inflam_2)_lamb_trt_cp_l1000_res.rds"  
saveRDS(res_list, file = fn)

```
## Debugging the loop
```{r}

res_list <- 
  # Loops over the gctx file
  lapply(cid_chunks[1:5], function(cur_chunk){
    rhdf5::h5closeAll()
    sig_list <- gctx_to_sigList(gctx_file, cur_chunk, decreasing_order = FALSE)
    # Loops over coefficients
    lapply(coefs, function(x){
      res_sub <- 
        res %>% 
        filter(coefficient == x)
      # Loops over gene thresh
      cmap_res <- 
        lapply(seq_along(gene_thresh), function(i){
          query_id <- thresh_names[i]
          n_genes <- gene_thresh[i]
          tmp_res <- res_sub %>% 
            arrange(desc(abs(t))) %>% 
            dplyr::slice(1:n_genes)
          
          up_genes <- tmp_res %>% 
            filter(t > 0) %>% 
            pull(entrezgene)
          up_genes <- as.character(up_genes)
          
          
          down_genes <- tmp_res %>% 
            filter(t < 0) %>% 
            pull(entrezgene)
          down_genes <- as.character(down_genes)
          
          out_res <- lamb_cmap_wrapper2(up_genes, down_genes, sig_list, n_cores = 6)
          
        }) %>% 
        setNames(., thresh_names) %>% 
        rbind_named_df_list(., 'query_id')
      
      return(cmap_res)
    }) %>% 
      setNames(., coefs) %>% 
      rbind_named_df_list(., 'coefficient')
  })  %>% 
  do.call(rbind, .)


```
# Appending newest results to CMAP files
## CMAP method
### Normal 
```{r}
cmap_fn <- 'Distefano_all_coefs_cmap_gsea_cp_l1000_res.rds'
append_fn <- 'Fibrosis_3-(Lob_Inflam_1+Lob_Inflam_2)_cmap_gsea_cp_l1000_res.rds'


cmap_res <-  
  readRDS(cmap_fn)
cmap_res$coefficient <- as.character(cmap_res$coefficient)
res_to_append <-
  readRDS(append_fn)
res_to_append$coefficient <-
  as.character(res_to_append$coefficient)
cmap_res <- rbind(cmap_res, res_to_append)
saveRDS(cmap_res, cmap_fn)



```

### Treat log2(1.2) 
```{r}
cmap_fn <- 'Distefano_all_coefs_treat_lfc_cmap_gsea_cp_l1000_res.rds'
append_fn <- 'Fibrosis_3-(Lob_Inflam_1+Lob_Inflam_2)_treat_lfc_cmap_gsea_cp_l1000_res.rds'


cmap_res <-  
  readRDS(cmap_fn)
cmap_res$coefficient <- as.character(cmap_res$coefficient)
res_to_append <-
  readRDS(append_fn)
res_to_append$coefficient <-
  as.character(res_to_append$coefficient)
cmap_res <- rbind(cmap_res, res_to_append)
saveRDS(cmap_res, cmap_fn)



```
## Lamb method
### Normal 
```{r}
cmap_fn <- 'Distefano_all_coefs_lamb_trt_cp_l1000_res.rds'
append_fn <- ''


cmap_res <-  
  readRDS(cmap_fn)
cmap_res$coefficient <- as.character(cmap_res$coefficient)
res_to_append <-
  readRDS(append_fn)
res_to_append$coefficient <-
  as.character(res_to_append$coefficient)
cmap_res <- rbind(cmap_res, res_to_append)
saveRDS(cmap_res, cmap_fn)



```

# Doing the cluster DEGs CMAP 
## Just running CMAP approved drug subst
```{r}
cp_kegg <- 
  'c2_kegg_entrez_msigdb_v7.0.gmt' %>% 
  clusterProfiler::read.gmt(.) %>% 
  split(., .$ont) %>% 
  lapply(., function(x){
    x$gene
  })




gctx_file <- '/zfs1/dtaylor/cmap_data/clue_test_data/sig_score_trt_cp_n204975x10174.gctx'
cids <- read.gctx.meta(gctx_file, dimension = 'column')[[1]]


trt_cp <- 
  read_rds('GSE92742_inst_metadata.rds') %>% 
  filter(pert_type == "trt_cp") %>% 
  distinct %>% 
  dplyr::select(one_of("pert_id", "sig_id"))
drgbnk_db <- 
  readRDS('pert_overlap_cmap_drugbank_stitch.rds')
drgbnk_db$stitch_name <- NULL
drgbnk_db$pubchem_cid <- NULL
drgbnk_db <- 
  na.omit(drgbnk_db) %>% 
  distinct
drug_meta <- inner_join(trt_cp, drgbnk_db)

cids = cids[cids %in% drug_meta$sig_id]

cid_chunks <- chunker(cids, 10)
```

## Using DEGs from Pathway group
```{r}






drgbnk_db <- 
  readRDS('pert_overlap_cmap_drugbank_stitch.rds')

cid_chunks <- chunker(cids, 10)

adj_p_val_thresh <- .001

degs_out_pth <- 
  read_csv("degs_from_selected_pathways_20200122.csv") %>% 
  filter(gene_adj.P.Val < adj_p_val_thresh) %>% 
  mutate(gene_regulation=if_else(gene_logFC > 0, "up", "down"))
names(degs_out_pth)[1] <- "coefficient"
degs_out_pth <- degs_out_pth %>% split(., .$coefficient)

deg_setlists <- 
  degs_out_pth %>% 
  map(function(x){
    degs_per_cat <- 
      split(x, x$category_level_1) %>% 
      map(function(y){
        up_genes <- y %>% 
          filter(gene_regulation == "up") %>% 
          pull(entrezgene) %>% 
          as.character %>% 
          paste(., collapse = ";")
        down_genes <- y %>% 
          filter(gene_regulation == "down") %>% 
          pull(entrezgene) %>% 
          as.character %>% 
          paste(., collapse = ";")
        return(tibble(up_genes, down_genes))
      }) %>% rbind_named_df_list(., "query_id")
  })

x <- deg_setlists[[1]]



```
### Running CMAP 
```{r}

out_res <- seq_along(deg_setlists)[1:2] %>% 
  map(function(i){
    x <- names(deg_setlists)[i]
    gene_sets <- deg_setlists[[x]]
    map(cid_chunks, function(y){
      sig_list <- 
        gctx_to_sigList(gctx_file, y, decreasing_order = FALSE)
      out_res <- cmap_fgsea_wrapper(gene_sets, sig_list, 4)
      out_res <- cbind(coefficient=x, out_res) %>% map_if(is.factor, as.character)
      out_res <- bind_cols(out_res)
    }) %>% 
      do.call(rbind, .) 
      
    
  }) 
names(out_res) <- names(out_res)[1:2]
  
# saveRDS(out_res, 'cmap_DEGs_from_pathway_clusters_res.rds')






```


## Using Fen's selected pathways
```{r}
fen_pths <- 
  read_delim("NAFLD_progression2path.txt", 
             "\t",
             col_names = FALSE) %>% 
  set_names(., c("fens_category", "id"))

pths_to_keep <- 
  fen_pths %>% filter(fens_category %in% 1:4)

kegg_db <- 
  read_rds("c2_kegg_entrez_msigdb_v7.0_database.rds") %>% 
  right_join(., fen_pths)

pths_to_use <- kegg_db %>% filter(fens_category %in% 1:4)
gene_pth_list <- 
  split(pths_to_use, pths_to_use$fens_category) %>% 
  map(function(x){
    x <- 
      str_split(x$entrezgene, "\\|") %>% 
      unlist %>% 
      unique
  }) 

gene_pth_list <- 
  seq_along(gene_pth_list) %>% map(function(i){
    nm <- names(gene_pth_list)[i]
    tibble(fens_category=nm, entrezgene=gene_pth_list[[i]])
  }) %>% do.call(rbind, .)

adj_p_val_thresh <- .001

degs_out_pth <- 
  read_csv("degs_from_selected_pathways_20200122.csv") %>% 
  filter(gene_adj.P.Val < adj_p_val_thresh) %>% 
  mutate(gene_regulation=if_else(gene_logFC > 0, "up", "down"))
names(degs_out_pth)[1] <- "coefficient"
degs_out_pth$entrezgene <- as.character(degs_out_pth$entrezgene)
degs_out_pth <-  inner_join(degs_out_pth, gene_pth_list)
degs_out_pth$fens_category <- paste0("fens_category_", degs_out_pth$fens_category)
degs_out_pth <- degs_out_pth %>% split(., .$coefficient)



deg_setlists <- 
  degs_out_pth %>% 
  map(function(x){
    degs_per_cat <- 
      split(x, x$fens_category) %>% 
      map(function(y){
        up_genes <- y %>% 
          filter(gene_regulation == "up") %>% 
          pull(entrezgene) %>% 
          as.character %>% 
          paste(., collapse = ";")
        down_genes <- y %>% 
          filter(gene_regulation == "down") %>% 
          pull(entrezgene) %>% 
          as.character %>% 
          paste(., collapse = ";")
        return(tibble(up_genes, down_genes))
      }) %>% rbind_named_df_list(., "query_id")
  })










```


### Running CMAP
```{r}

out_res <- seq_along(deg_setlists)[1:2] %>% 
  map(function(i){
    x <- names(deg_setlists)[i]
    gene_sets <- deg_setlists[[x]]
    map(cid_chunks, function(y){
      sig_list <- 
        gctx_to_sigList(gctx_file, y, decreasing_order = FALSE)
      out_res <- cmap_fgsea_wrapper(gene_sets, sig_list, 4)
      out_res <- cbind(coefficient=x, out_res) %>% map_if(is.factor, as.character)
      out_res <- bind_cols(out_res)
    }) %>% 
      do.call(rbind, .) 
      
    
  }) 
names(out_res) <- names(out_res)[1:2]
  
# saveRDS(out_res, 'cmap_DEGs_from_fens_selected_pathways_es.rds')




```



# Converting sig x gene to sig x pathway matrix
```{r}
library(GSVA)
library(clusterProfiler)

cp_kegg <- 
  'c2_kegg_entrez_msigdb_v7.0.gmt' %>% 
  read.gmt(.) %>% 
  split(., .$ont) %>% 
  lapply(., function(x){
    x$gene
  })




gctx_file <- '/zfs1/dtaylor/cmap_data/clue_test_data/sig_score_trt_cp_n204975x10174.gctx'
cids <- read.gctx.meta(gctx_file, dimension = 'column')[[1]]


trt_cp <- 
  read_rds('GSE92742_inst_metadata.rds') %>% 
  filter(pert_type == "trt_cp") %>% 
  distinct %>% 
  dplyr::select(one_of("pert_id", "sig_id"))
drgbnk_db <- 
  readRDS('pert_overlap_cmap_drugbank_stitch.rds')
drgbnk_db$stitch_name <- NULL
drgbnk_db$pubchem_cid <- NULL
drgbnk_db <- 
  na.omit(drgbnk_db) %>% 
  distinct
drug_meta <- inner_join(trt_cp, drgbnk_db)

cids = cids[cids %in% drug_meta$sig_id]

cid_chunks <- chunker(cids, 100)

sig_x_pth <- seq_along(cid_chunks) %>%  
  map(function(i){
    x <- cid_chunks[[i]]
    print(i)
    sig_list <- 
      parse.gctx(gctx_file,cid = x,matrix_only = TRUE)
    gsva_res_sva <- 
      gsva(sig_list@mat, cp_kegg, method='gsva',  min.sz=1, max.sz=100000, parallel.sz=8)
  })
sig_x_pth <- do.call(cbind, sig_x_pth)
#saveRDS(sig_x_pth, file="l1000_sig_by_pth_gsva_kegg.rds")

```

